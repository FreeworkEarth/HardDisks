# LAMMPS Hard Disk Gas Simulation

This directory contains LAMMPS implementations of the 2D hard disk gas simulations from the `hspist3` C code. The simulations study non-equilibrium thermodynamics, energy transfer, and speed of sound in granular gases using a movable divider wall with optional spring mechanics.

## Overview

The LAMMPS implementation replicates the key physics from the original C simulation:

- **2D hard disk particles** with elastic collisions (WCA potential)
- **Movable divider wall** with finite mass
- **Spring-loaded wall** for energy measurement experiments
- **Event-driven-like dynamics** with small timesteps for accuracy
- **Energy and momentum conservation**
- **Temperature control and measurement**

## Files

### Input Scripts

| File | Description |
|------|-------------|
| `in.harddisk` | Main simulation with movable wall and spring |
| `in.speed_of_sound` | Speed of sound measurement via wall oscillations |
| `in.energy_transfer` | Energy transfer from right chamber to left via spring |

### Analysis Scripts

| File | Description |
|------|-------------|
| `analyze_oscillations.py` | FFT analysis of wall oscillations → extract frequency |
| `analyze_energy_transfer.py` | Energy flow analysis: KE_right → SpringPE → KE_left |

### Output Files

| File | Generated By | Contents |
|------|--------------|----------|
| `traj.lammpstrj` | LAMMPS dump | Atom positions (for OVITO visualization) |
| `traj_detailed.lammpstrj` | LAMMPS dump | Positions + velocities + forces |
| `wall_position.dat` | LAMMPS print | Wall position, displacement, particle counts |
| `energy.dat` | LAMMPS print | KE, PE, temperature, total energy |
| `wall_oscillation.dat` | Speed of sound run | High-frequency wall position logging |
| `energy_transfer.dat` | Energy transfer run | Chamber-specific energies |

## Installation Requirements

### LAMMPS
```bash
# Install LAMMPS (choose one method):

# Option 1: Conda (recommended)
conda install -c conda-forge lammps

# Option 2: Homebrew (macOS)
brew install lammps

# Option 3: Build from source
git clone https://github.com/lammps/lammps.git
cd lammps
mkdir build && cd build
cmake ../cmake -DPKG_MOLECULE=yes -DPKG_RIGID=yes
make -j4
```

### Python Analysis Tools
```bash
pip install numpy scipy matplotlib
```

### OVITO (Visualization)

Download the free version from: https://www.ovito.org/

**OVITO Free** can:
- Load `.lammpstrj` trajectory files
- Visualize particle motion and wall dynamics
- Create publication-quality renderings
- Export movies (MP4, AVI)

## Usage

**Note:** On macOS with Homebrew, LAMMPS is installed as `lmp_serial` (or `lmp_mpi` for parallel). Replace `lammps` with `lmp_serial` in the commands below, or the script will auto-detect the correct command.

### 1. Run Basic Simulation

```bash
# Run main simulation (use lmp_serial on macOS/Homebrew)
lmp_serial -in in.harddisk

# Visualize in OVITO
ovito traj.lammpstrj
```

### 2. Speed of Sound Experiment

This experiment measures the natural oscillation frequency of the divider wall to determine the speed of sound in the 2D hard disk gas.

```bash
# Run simulation
lmp_serial -in in.speed_of_sound

# Analyze oscillation frequency
python analyze_oscillations.py wall_oscillation.dat \
    --dt 10 \
    --dt-timestep 0.00005 \
    --L0 7.5 \
    --wall-mass-factor 20.0 \
    --output speed_of_sound_results

# View results
cat speed_of_sound_results_results.txt
```

**Expected Output:**
- Dominant oscillation frequency
- Measured speed of sound vs theoretical (c_s = √2 ≈ 1.414 for 2D ideal gas at T=1)
- FFT power spectrum plot

### 3. Energy Transfer Experiment

This experiment starts with all particles in the right chamber and the wall pulled to the left by a spring. Energy flows: KE_right → Spring PE → KE_left.

```bash
# Run simulation
lmp_serial -in in.energy_transfer

# Analyze energy flow
python analyze_energy_transfer.py \
    --energy-file energy_transfer.dat \
    --wall-file wall_energy_transfer.dat \
    --output energy_transfer_results

# View results
cat energy_transfer_results_results.txt
```

**Expected Output:**
- Energy transfer efficiency (KE_left / KE_initial_right)
- Maximum spring potential energy
- Particle migration between chambers
- Energy conservation check

## OVITO Visualization Guide

### Loading Trajectories

1. **Open OVITO** (free version works perfectly)
2. **File → Load File** → Select `traj.lammpstrj` or `traj_detailed.lammpstrj`
3. OVITO auto-detects LAMMPS format

### Visualization Tips

**Basic Visualization:**
- Particles appear as spheres (type 1 = gas particles)
- Wall appears as single large atom (type 2)

**Enhance Visualization:**
1. **Particle size**: Pipeline → Modify → Adjust radii
   - Set type 1 radius to 0.5σ (particle radius)
   - Set type 2 radius to 0.5σ (wall half-thickness)

2. **Color by type**:
   - Pipeline → Color coding → Particle type
   - Type 1: Blue (particles)
   - Type 2: Red (wall)

3. **Add simulation box**:
   - Pipeline → Visual elements → Simulation cell (enable)

4. **Track wall motion**:
   - Data inspector → Select wall atom (last atom ID)
   - View x-coordinate vs frame

**Create Movies:**
1. Render → Animation
2. Set frame range
3. Choose format (MP4 recommended)
4. Resolution: 1920×1080 or higher
5. Click "Render to file"

**Python Scripting in OVITO:**
```python
from ovito.io import import_file
from ovito.vis import Viewport

pipeline = import_file('traj.lammpstrj')
pipeline.add_to_scene()

vp = Viewport()
vp.type = Viewport.Type.Perspective
vp.camera_pos = (0, 0, 50)
vp.camera_dir = (0, 0, -1)

vp.render_image(filename='snapshot.png', size=(1920, 1080))
```

## Physics Parameters

### Default Values (LJ reduced units)

| Parameter | Symbol | Value | Description |
|-----------|--------|-------|-------------|
| Particle diameter | σ | 1.0 | Length unit |
| Particle mass | m | 1.0 | Mass unit |
| Temperature | T | 1.0 | Energy unit (k_B = 1) |
| Box half-width | L₀ | 20.0 σ | Adjustable |
| Box height | H | 10.0 σ | Adjustable |
| Wall mass factor | M/m | 200 | Heavy wall (slow dynamics) |
| Spring constant | k | 1000 | Strong spring |
| Timestep | dt | 0.000125 | 1/8000 (for stability) |

### 2D Ideal Gas Theory

For a 2D monatomic ideal gas:
- **Equipartition**: ⟨KE⟩ = N k_B T (2 DOF per particle)
- **Temperature**: T = KE / (N k_B)
- **Speed of sound**: c_s = √(γ k_B T / m) where γ = 2
- **At T=1, m=1**: c_s = √2 ≈ 1.414

## Comparison with Original C Code

| Feature | hspist3 (C) | LAMMPS |
|---------|-------------|--------|
| Collision method | Event-driven CCD | MD with stiff WCA |
| Hard disk potential | Exact (zero overlap) | Soft-core repulsion |
| Wall implementation | Custom CCD | Single massive atom |
| Spring mechanism | Direct force | `fix spring tether` |
| Timestep | 0.001 / 8 substeps | 0.000125 (equivalent) |
| Energy conservation | Exact (elastic) | ~10⁻⁶ relative drift |
| Visualization | OpenGL real-time | OVITO post-processing |

### Advantages of LAMMPS

- ✅ **No custom coding** required for physics
- ✅ **Built-in analysis tools** (computes, fixes)
- ✅ **Parallel scalability** (MPI)
- ✅ **Standard trajectory format** (OVITO compatible)
- ✅ **Extensive documentation** and community

### Advantages of Original C Code

- ✅ **Exact hard disk collisions** (zero overlap)
- ✅ **Event-driven efficiency** (no wasted integration)
- ✅ **Real-time visualization** (interactive)
- ✅ **Custom experiments** (full control)

## Parameter Sweep Scripts

### Vary Wall Mass

```bash
#!/bin/bash
for wmass in 10 20 50 100 200 500; do
    sed "s/wmass equal 20.0/wmass equal $wmass/" in.speed_of_sound > tmp.in
    lammps -in tmp.in -log log.wmass_$wmass
    mv wall_oscillation.dat wall_oscillation_wmass_$wmass.dat
done
```

### Vary Box Size

```bash
#!/bin/bash
for L0 in 7.5 10.0 15.0 20.0 30.0; do
    sed "s/L0 equal 7.5/L0 equal $L0/" in.speed_of_sound > tmp.in
    lammps -in tmp.in -log log.L0_$L0
    mv wall_oscillation.dat wall_oscillation_L0_$L0.dat
done
```

## Troubleshooting

### Issue: Particles overlap or pass through walls
**Solution**: Decrease timestep (`dt equal 0.00005` or smaller)

### Issue: Energy not conserved
**Solution**:
- Check NVE integration (no thermostats during measurement)
- Verify pair potential cutoff ≥ particle diameter
- Reduce timestep

### Issue: Wall doesn't oscillate
**Solution**:
- Ensure wall is released (`unfix hold_wall`)
- Check spring constant (increase k for stronger restoring force)
- Verify wall mass is set correctly

### Issue: OVITO doesn't load trajectory
**Solution**:
- Check file format: LAMMPS atom style (`dump ... atom ...`)
- Verify file permissions
- Try: `ovito --verbose traj.lammpstrj` for debug info

## Advanced: Custom Analysis with LAMMPS Python Interface

```python
from lammps import lammps

lmp = lammps()
lmp.file("in.harddisk")

# Access thermo data
natoms = lmp.get_natoms()
temp = lmp.extract_compute("temp_particles", 0, 0)
ke = lmp.extract_compute("ke_particles", 0, 0)

# Access atom positions
x = lmp.gather_atoms("x", 1, 3)
```

## References

1. **Original Code**: `hspist3/00ALLINONE.c` - Event-driven hard disk simulation with CCD
2. **LAMMPS Manual**: https://docs.lammps.org/
3. **OVITO Manual**: https://www.ovito.org/docs/
4. **2D Hard Disks**: Alder & Wainwright (1957), *J. Chem. Phys.*

## Citation

If you use this code, please cite:
```
LAMMPS implementation of 2D hard disk gas with movable wall
Based on hspist3 simulation (2025)
https://github.com/[your-repo]/HardDisks
```

## Contact

For questions about the LAMMPS implementation, see issues or contact the repository maintainer.

For LAMMPS-specific help: https://matsci.org/c/lammps

For OVITO help: https://www.ovito.org/forum/
